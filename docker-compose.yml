version: "3.9"

services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: basketball
      POSTGRES_USER: basketball
      POSTGRES_PASSWORD: basketball
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U basketball -d basketball" ]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - db_data:/var/lib/postgresql/data

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      PGHOST: db
      PGPORT: 5432
      PGUSER: basketball
      PGPASSWORD: basketball
      PGDATABASE: basketball
      METRICS_REGISTRY_PATH: /app/metrics/registry.yaml
      ETL_CSV_ROOT: /app/data
      ETL_EXPECTATIONS_PATH: /app/etl/expectations.yaml
      # Optional:
      # API_LOG_LEVEL: info
      # API_WORKERS: 2
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8000:8000"
    command: [ "python", "-m", "scripts.cli", "run-api", "--host", "0.0.0.0", "--port", "8000" ]

  frontend:
    build:
      context: .
      # Explicitly specify Dockerfile.frontend in case default differs
      dockerfile: Dockerfile.frontend
    environment:
      NEXT_PUBLIC_API_BASE_URL: http://api:8000
    depends_on:
      - api
    ports:
      - "3000:3000"
    command: [ "npm", "run", "start" ]

  # One-off ETL runner (not started by default).
  # Usage example:
  #   docker compose run --rm \
  #     -v /path/to/local/csv:/app/data \
  #     etl python -m scripts.cli run-etl --mode full
  etl:
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      PGHOST: db
      PGPORT: 5432
      PGUSER: basketball
      PGPASSWORD: basketball
      PGDATABASE: basketball
      METRICS_REGISTRY_PATH: /app/metrics/registry.yaml
      ETL_CSV_ROOT: /app/data
      ETL_EXPECTATIONS_PATH: /app/etl/expectations.yaml
    depends_on:
      db:
        condition: service_healthy
    entrypoint: [ "python", "-m", "scripts.cli", "run-etl", "--mode", "full" ]
    profiles:
      - etl

volumes:
  db_data:
